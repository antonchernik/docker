#!/usr/bin/env groovy
import hudson.FilePath;
import jenkins.model.Jenkins;

def BRANCH_TMP_LIST


pipeline {
    agent { label 'ubuntu' }

    environment {
        DOCKER_REGISTRY="docker.io/antonchernik/"
        GIT_CREDENTIALS_ID="github_antonchernik_ssh"
        DOCKER_CREDENTIALS_ID="docker-antonchernik"
        DOCKER_IMAGE="ubuntu"
        DOCKER_IMAGE_VERSION="18.04.4"
    }
    stages {
        stage('Checkout') {
            steps {
                echo "Cleaning workspace"
                sh(returnStdout: true, script: "git rev-parse --verify HEAD")
                echo "Resetting working tree"
                sh(returnStdout: true, script: "git reset --hard")
                sh(returnStdout: true, script: "git clean -fdx")
                git branch: "master", credentialsId: GIT_CREDENTIALS_ID, url: "git@github.com:antonchernik/docker.git"
            }
        }
        stage('Build image') {
            steps {
                sh(returnStdout: true, script: "docker build -f library/${DOCKER_IMAGE}/${DOCKER_IMAGE_VERSION}/Dockerfile -t ${DOCKER_REGISTRY}${DOCKER_IMAGE}:${DOCKER_IMAGE_VERSION}.${env.BUILD_ID} .")
            }
        }
        stage('Image vulnerabilities check') {
            steps {
                script {
                    sh(returnStdout: true, script: "trivy --output trivy.txt ${DOCKER_REGISTRY}${DOCKER_IMAGE}:${DOCKER_IMAGE_VERSION}.${env.BUILD_ID} || true")
                    publishHTML([
                    	allowMissing: false,
                    	alwaysLinkToLastBuild: false,
                    	keepAll: false,
                    	reportDir: 'bionic',
                    	reportFiles: 'trivy.txt',
                    	reportName: 'Trivy Report',
                    	reportTitles: ''
                    ])
                }
            }
        }
        stage('Push image') {
            steps {
                withDockerRegistry([ credentialsId: DOCKER_CREDENTIALS_ID, url: "" ]) {
                    sh(returnStdout: true, script: "docker push ${DOCKER_REGISTRY}${DOCKER_IMAGE}:${DOCKER_IMAGE_VERSION}.${env.BUILD_ID}")
                    sh(returnStdout: true, script: "docker tag ${DOCKER_REGISTRY}${DOCKER_IMAGE}:${DOCKER_IMAGE_VERSION}.${env.BUILD_ID} ${DOCKER_REGISTRY}${DOCKER_IMAGE}:latest")
                    sh(returnStdout: true, script: "docker push ${DOCKER_REGISTRY}${DOCKER_IMAGE}:latest")
                }

            }
        }
        stage('Cleanup') {
            steps {
                sh(returnStdout: true, script: "docker rmi ${DOCKER_REGISTRY}${DOCKER_IMAGE}:${DOCKER_IMAGE_VERSION}.${env.BUILD_ID}")
                sh(returnStdout: true, script: "docker rmi ${DOCKER_REGISTRY}${DOCKER_IMAGE}:latest")
            }
        }
        stage('Update readme') {
            steps {
                script {
                    GIT_URL_TAG="sed -i 's~<br/>~"+"<br/>" + "* ${DOCKER_IMAGE_VERSION}.${env.BUILD_ID} "+"Dockerfile [(bionic/Dockerfile)]("+"https://github.com/antonchernik/docker/blob/${DOCKER_IMAGE}-v${DOCKER_IMAGE_VERSION}.${env.BUILD_ID}/library/${DOCKER_IMAGE}/${DOCKER_IMAGE_VERSION}/Dockerfile)"+"<br />"+"Trivy security report [(bionic/trivy.txt)]("+"https://github.com/antonchernik/docker/blob/${DOCKER_IMAGE}-v${DOCKER_IMAGE_VERSION}.${env.BUILD_ID}/library/${DOCKER_IMAGE}/${DOCKER_IMAGE_VERSION}/trivy.txt)"+"<br />"+"~g' README.md"
                }
                sh(returnStdout: true, script: GIT_URL_TAG)

            }
        }
        stage('Set GIT tag') {
            steps {
                sshagent (credentials: [GIT_CREDENTIALS_ID]) {
                    sh(returnStdout: true, script:'git config --global user.email "anton.chernik@gmail.com"')
                    sh(returnStdout: true, script:'git config --global user.name "Anton Chernik"')
                    sh(returnStdout: true, script:'git add --all')
                    sh(returnStdout: true, script:'git commit -am "Update trivy report"')
                    sh(returnStdout: true, script:"git tag -a ${DOCKER_IMAGE}-v${DOCKER_IMAGE_VERSION}.${env.BUILD_ID} -m 'Build ${DOCKER_IMAGE}:${DOCKER_IMAGE_VERSION}.${env.BUILD_ID}'")
                    sh(returnStdout: true, script:'git push origin master --tags')
                }
            }
        }
    }
}
